بسم الله الرحمن الرحيم،

تحدثت في منشور سابق عن [مشروع منجم](https://community.itqan.dev/d/178/7)، وهو مشروع مفتوح المصدر لأتمتة تقطيع ومزامنة التلاوات القرآنية.

وتحدثت كذلك عن بعض التحديات في خوارزمية المحاذاة، حيث أننا واجهنا مشاكل في آيات بعض السور ومنها سورة البقرة.

لذلك، في هذا المنشور سأفصل كثيرًا في هذا التحدي وأخيرًا سأستعرض كيف حللنا هذا التحدي.

## أولاً: كيف اكتشفنا هذه المشكلة؟

<!-- video on the QA tool -->

لقد عملنا على تنفيذ لوحة تحكم لاستعراض مخرجات منجم واختبارها، ومن خلال هذه اللوحة يمكن التبليغ عن أي مشكلة في المحاذاة.

**ملاحظة**: بإمكانك المشاركة في اختبار مخرجات منجم، رد بتعليق وسيتم التواصل معك وإعطائك وصول!

بعد ذلك بدأ الأخ أحمد شمس في اختبار المخرجات وقد بلغ عن مشكلة بين الآية ١٠٦ و ١٠٧، وكذلك أن مجموع الآيات التي تمت مزامنتها كانت **١١٤ فقط من أصل ٢٨٦** في سورة البقرة باستخدام الخوارزمية الجشعة القديمة!

![Screenshot 2026-01-02 at 10.30.05 PM.png](attachment:b39bc901-9aa0-4e0d-ad61-7d8c0b0d7616:Screenshot_2026-01-02_at_10.30.05_PM.png)

دعونا نستمع معًا لهذه الآيات حتى نعرض شكل المشكلة:

<!-- video recording of the problematic ayat -->

## ما الذي يحصل هنا؟

أولاً بعد تقسيم التلاوة بناءً على السكتات، هذه هي الـ segments:

```
# المقطع الأول
۞مَا نَنسَخۡ مِنۡ ءَايَةٍ أَوۡ نُنسِهَا نَأۡتِ بِخَيۡرٖ مِّنۡهَآ أَوۡ مِثۡلِهَآۗ

# المقطع الثاني
أَلَمۡ تَعۡلَمۡ أَنَّ ٱللَّهَ عَلَىٰ كُلِّ شَيۡءٖ قَدِيرٌ

# المقطع الثالث
أَلَمۡ تَعۡلَمۡ أَنَّ ٱللَّهَ لَهُۥ مُلۡكُ ٱلسَّمَٰوَٰتِ وَٱلۡأَرۡضِۗ وَمَا لَكُم مِّن دُونِ ٱللَّهِ مِن وَلِيّٖ وَلَا نَصِيرٍ
```

```
# الآية ١٠٦
۞مَا نَنسَخۡ مِنۡ ءَايَةٍ أَوۡ نُنسِهَا نَأۡتِ بِخَيۡرٖ مِّنۡهَآ أَوۡ مِثۡلِهَآۗ أَلَمۡ تَعۡلَمۡ أَنَّ ٱللَّهَ عَلَىٰ كُلِّ شَيۡءٖ قَدِيرٌ

# الآية ١٠٧
أَلَمۡ تَعۡلَمۡ أَنَّ ٱللَّهَ لَهُۥ مُلۡكُ ٱلسَّمَٰوَٰتِ وَٱلۡأَرۡضِۗ وَمَا لَكُم مِّن دُونِ ٱللَّهِ مِن وَلِيّٖ وَلَا نَصِيرٍ
```

طيب الآن نحتاج أن نحاذي هذه المقاطع، لنخرج بآيات متكاملة بمقاطع صوتية صحيحة.

## خوارزمية المحاذاة الجشعة (Greedy Algorithm)

أولاً سيستلم منجم المقطع الأول، وسينفذ مجموعة تأكيدات:

### ١. Last Words Similarity (تشابه الكلمات الأخيرة)

ما هي نسبة المطابقة بين آخر ٣ كلمات من المقطع الحالي (المقطع الأول) مقارنة بآخر ٣ كلمات من الآية ١٠٦؟

حتى ينجح هذا التأكيد ويتم اعتبار المقطع مكتملاً ويتم اعتباره أنه فعلاً الآية رقم ١٠٦، يجب أن تكون نسبة المطابقة على الأقل فوق **٦٠%**.

في هذه الحالة فنسبة المطابقة صفر لذلك سننتقل للتأكيد الثاني.

### ٢. Coverage Ratio Check (نسبة التغطية)

عدد الكلمات في المقطع الحالي (المقطع الأول) = X
وعدد الكلمات في الآية رقم ١٠٦ = XX

فبذلك فنسبة الـ coverage تساوي **٤٠%**. ولكي ينجح هذا التأكيد يجب أن يكون على الأقل فوق **٧٠%** ولذلك سنستمر في التأكيد الذي بعده.

### ٣. Next Segment First Words (بداية المقطع القادم)

ما هي نسبة المطابقة بين بداية المقطع القادم (المقطع الثاني) مقارنة ببداية الآية القادمة (رقم ١٠٧)؟

إذا كانت نسبة المطابقة فوق **٦٠%** معناه أن المقطع الحالي قد تمت محاذاته، والمقطع القادم هو فعلاً بداية الآية القادمة.

## المشكلة: False Positive

هذه الخوارزمية تعمل على **٩٨%** من آيات القرآن، لكن في الآيتين ١٠٦ و ١٠٧ ستفشل الخوارزمية عند التأكيد رقم ٣!

**السبب**: منتصف الآية الأولى يساوي بداية الآية القادمة!

```
الآية ١٠٦: "... أَلَمۡ تَعۡلَمۡ أَنَّ ٱللَّهَ عَلَىٰ كُلِّ شَيۡءٖ قَدِيرٌ"
               ^^^^^^^^^^^^^^^^^^^^^^^^
الآية ١٠٧: "أَلَمۡ تَعۡلَمۡ أَنَّ ٱللَّهَ لَهُۥ مُلۡكُ..."
            ^^^^^^^^^^^^^^^^^^^^^^^^
```

كلا النصين يبدآن بـ "أَلَمۡ تَعۡلَمۡ أَنَّ ٱللَّهَ" (ألم تعلم أن الله)!

فيتوقف منجم عن محاذاة الآية رقم ١٠٦ ويبدأ في الآية رقم ١٠٧ وهذا ملاحظ في المقطع الصوتي السابق.

## لماذا الخوارزمية الجشعة تفشل؟

الخوارزمية الجشعة تتخذ **قرارات محلية** بدون رؤية الصورة الكاملة:

```
الخطوة ١: [seg1 seg2] → الآية 1؟ ربما... نعم ✓
الخطوة ٢: [seg3] → الآية 2؟ لا، ادمج المزيد...
الخطوة ٣: [seg3 seg4 seg5...] → لا تطابق... استمر...
الخطوة ٤: في النهاية تفشل أو تدمج كل شيء!

❌ إذا كانت الخطوة ١ خاطئة، كل الخطوات اللاحقة تتأثر!
```

## كيف يمكن حل هذه المشكلة؟

هذه المشكلة ونواقص كثيرة في المحاذاة قدحت في ذهني فكرة:

**أولاً**: هذه ليست مشاكل جديدة ولم يتم حلها مسبقاً في مجالات أخرى.

**ثانياً**: لا يمكنني الاستمرار في تحليل edge cases، أنا مؤمن أن هناك مشكلة جوهرية!

وذلك مما دفعني للدخول في محادثة مطولة مع Claude Opus 4.5 في البحث عن مجالات لديها مشكلة متشابهة.

وخرجت معي هذه القائمة:

### ١. Bioinformatics (المعلوماتية الحيوية)

وهو العلم المختص في البيانات الطويلة للجينات ومعالجتها برمجياً. عندما يريد العلماء مقارنة تسلسل DNA بآخر، يستخدمون خوارزمية **Needleman-Wunsch** التي تجد أفضل محاذاة بين تسلسلين.

### ٢. Voice Recognition (التعرف الصوتي)

في مجال التعرف على الكلام، يستخدمون تقنية **Dynamic Time Warping (DTW)** لمحاذاة الإشارات الصوتية مع النصوص حتى لو كانت بسرعات مختلفة.

## الحل: البرمجة الديناميكية (Dynamic Programming)

تكمن الإجابة في هذه الخوارزميات الثلاث:

### ١. ما هي البرمجة الديناميكية؟

هي طريقة لحل المشاكل المعقدة عن طريق:
- تقسيمها إلى مشاكل فرعية متداخلة
- حفظ نتائج المشاكل الفرعية لتجنب إعادة حسابها

```python
# مثال: متتالية فيبوناتشي
# بدون DP (بطيء جداً)
def fib(n):
    if n <= 1: return n
    return fib(n-1) + fib(n-2)  # يعيد حساب نفس القيم!

# مع DP (سريع)
def fib_dp(n):
    dp = [0, 1]
    for i in range(2, n+1):
        dp.append(dp[i-1] + dp[i-2])  # يحفظ ويعيد استخدام!
    return dp[n]
```

### ٢. كيف طبقناها في منجم؟

بدلاً من اتخاذ قرارات محلية، نبني جدول ثنائي الأبعاد:
- **المحور الأفقي**: الآيات (١ إلى ٢٨٦)
- **المحور العمودي**: المقاطع الصوتية (٠ إلى ٨٣١)

```
         الآيات →
         1    2    3    4    ...  286
مقطع 0  [0]   
مقطع 1  [?]  [?]
مقطع 2  [?]  [?]  [?]
مقطع 3  [?]  [?]  [?]  [?]
...                              
مقطع 831                         [الهدف]
```

كل خلية `dp[i][j]` تمثل **أفضل تكلفة** لمحاذاة المقاطع `[0:i]` مع الآيات `[0:j]`.

### ٣. صيغة التكرار (Recurrence Relation)

```python
dp[i][j] = min over k of (
    dp[i-k][j-1] + cost(segments[i-k:i], ayah[j])
)

حيث:
- dp[i-k][j-1] = أفضل تكلفة لمحاذاة أول i-k مقاطع مع أول j-1 آيات
- cost() = 1 - similarity (كلما قلت التكلفة كان أفضل)
```

### ٤. التتبع الخلفي (Backtracking)

بعد ملء الجدول، نتتبع المسار الأمثل:

```python
path = []
current = (n_seg, n_ayah)
while current:
    cell = dp[current]
    path.append(cell)
    current = cell.parent
path.reverse()
```

## التحسينات المطبقة

لجعل الخوارزمية سريعة بما فيه الكفاية:

### ١. تخزين النصوص المدمجة مسبقاً

```python
merged_cache: dict[tuple[int, int], str] = {}

def get_merged_text(start: int, end: int) -> str:
    if (start, end) not in merged_cache:
        merged_cache[(start, end)] = " ".join(...)
    return merged_cache[(start, end)]
```

### ٢. تخزين حسابات التشابه

```python
sim_cache: dict[tuple[str, int], float] = {}
```

### ٣. تحديد نطاق البحث

```python
min_i = j  # على الأقل j مقاطع لـ j آيات
max_i = n_seg - (n_ayah - j) + 1  # ترك مساحة للباقي
```

### ٤. تحديد عدد المقاطع المدمجة

الحد الأقصى ٨ مقاطع لكل آية (بدلاً من ١٥).

## النتائج: قبل وبعد

### سورة البقرة (٢٨٦ آية) - ١٠٠% تغطية!

| المقياس | الخوارزمية الجشعة | البرمجة الديناميكية | التحسن |
|---------|-------------------|---------------------|--------|
| **الآيات المحاذاة** | ١١٤ (٤٠%) | **٢٨٦ (١٠٠%)** | +١٧٢ آية |
| **متوسط التشابه** | 0.869 | **0.866** | مشابه |
| **أقل تشابه** | 0.032 | 0.109 | +0.077 |
| **الوقت** | 0.34 ثانية | 57 ثانية | أبطأ |

### سورة الكهف (١١٠ آيات) - ١٠٠% تغطية!

| المقياس | النتيجة |
|---------|---------|
| **الآيات المحاذاة** | **١١٠/١١٠ (١٠٠%)** |
| **متوسط التشابه** | **0.947** |

### الآيات الإشكالية

| الآية | الجشعة | DP | التحسن |
|-------|--------|-----|--------|
| ١٠٦ | 0.044 | **0.994** | **+0.950** |
| ١٠٧ | 0.032 | **0.980** | **+0.948** |
| ١١٠ | 0.069 | **0.973** | **+0.904** |
| ١٠٥ | 0.093 | **0.992** | **+0.899** |
| ١٠٣ | 0.096 | **0.992** | **+0.896** |

## لماذا تعمل البرمجة الديناميكية بشكل أفضل؟

١. **التحسين الشامل (Global Optimization)**: تنظر في جميع الاحتمالات الممكنة
٢. **لا تتأثر بالأخطاء المتتالية**: خطأ في مكان لا يؤثر على البقية
٣. **التتبع الخلفي**: يمكن إيجاد المسار الأمثل عبر التسلسل كامل
٤. **التعامل مع الغموض**: عندما يمكن لعدة مقاطع أن تبدأ آية، DP تقيّم كل الخيارات

## الدروس المستفادة

### ١. الخوارزمية الجشعة vs البرمجة الديناميكية

- **الجشعة**: سريعة وبسيطة، لكن قد تعلق في الحلول المحلية
- **DP**: أبطأ وأكثر تعقيداً، لكن تجد الحل الأمثل عالمياً

### ٢. متى نستخدم DP؟

- المشكلة لديها بنية فرعية مثلى (Optimal Substructure)
- نفس المشاكل الفرعية تظهر مراراً
- نحتاج الحل الأمثل عالمياً
- يمكننا تحمل تكلفة الوقت/الذاكرة الإضافية

### ٣. أهمية دراسة المجالات الأخرى

من علم الجينات (Bioinformatics) والتعرف الصوتي (Speech Recognition) تعلمنا خوارزميات يمكن تطبيقها على مشكلتنا!

## الكود المصدري

يمكنكم الاطلاع على الكود في:
- [`munajjam/core/aligner_dp.py`](https://github.com/Itqan-community/Munajjam/blob/main/munajjam/munajjam/core/aligner_dp.py) - خوارزمية DP الجديدة (المستخدمة حالياً)
- [`munajjam/core/aligner.py`](https://github.com/Itqan-community/Munajjam/blob/main/munajjam/munajjam/core/aligner.py) - الخوارزمية الجشعة الأصلية
- [`batch_process.py`](https://github.com/Itqan-community/Munajjam/blob/main/batch_process.py) - معالج الدفعات باستخدام DP

### استخدام خوارزمية DP في الإنتاج

```python
from munajjam.core.aligner_dp import align_segments_dp_with_constraints

# محاذاة المقاطع باستخدام البرمجة الديناميكية
results = align_segments_dp_with_constraints(
    segments, 
    ayahs, 
    silences_ms=silences,
    max_segments_per_ayah=8  # الحد الأقصى للمقاطع لكل آية
)
```

## الأداء والسرعة

تمت معالجة **القرآن الكريم كاملاً (١١٤ سورة)** باستخدام:

| المقياس | القيمة |
|---------|--------|
| الوقت الإجمالي | **٥١.٧ دقيقة** |
| متوسط الوقت لكل سورة | **٢٧.٢ ثانية** |
| GPU | NVIDIA RTX 4060 (CUDA, TF32) |

**التحسينات المستخدمة:**
- GPU: NVIDIA RTX 4060 (CUDA, TF32 enabled)
- معالجة متوازية لاكتشاف السكتات (١٠ عمال)
- تحميل الآيات مسبقاً في الذاكرة
- حفظ الملفات بشكل غير متزامن
- تنظيف دوري لذاكرة GPU

## الخلاصة

بفضل الله ثم بالبحث والتعلم من مجالات أخرى، تمكنا من حل مشكلة المحاذاة التي كانت تعيق منجم. 

**النتائج النهائية:**
- سورة البقرة: **٢٨٦/٢٨٦ آية (١٠٠%)** بمتوسط تشابه **0.866**
- سورة الكهف: **١١٠/١١٠ آية (١٠٠%)** بمتوسط تشابه **0.947**
- القرآن كاملاً: **١١٤ سورة** في **٥١.٧ دقيقة**

الآن نستطيع محاذاة **١٠٠%** من آيات السور الطويلة والمعقدة بدقة عالية!

هذا يذكرنا بأهمية:
- عدم الاستسلام عند مواجهة التحديات
- البحث في مجالات أخرى للإلهام
- التعلم المستمر من علوم الحاسوب الأساسية

**ما رأيكم؟ هل لديكم أفكار أخرى لتحسين منجم؟**

---

*كُتب بتاريخ: ٢ يناير ٢٠٢٦*
